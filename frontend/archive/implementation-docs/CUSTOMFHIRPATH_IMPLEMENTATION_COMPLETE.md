# CustomFHIRPath Rule Authoring - IMPLEMENTATION COMPLETE

## Overview
Successfully migrated CustomFHIRPath rule authoring to the unified RuleForm architecture with governed error code validation.

**Date:** 29 December 2025  
**Status:** ✅ IMPLEMENTATION COMPLETE | ✅ BUILD SUCCESSFUL

---

## Architecture Compliance

All 7 architecture requirements met:

1. ✅ **RuleForm.tsx for create and edit** - No standalone forms
2. ✅ **Rule-specific ConfigSection ONLY** - CustomFHIRPathConfigSection handles expression + errorCode only
3. ✅ **Governed ErrorCode** - REQUIRED dropdown with validated list (8 codes)
4. ✅ **Resource selection collapses** - Inherited from shared ResourceSelector
5. ✅ **Edit mode locks resource** - Inherited from RuleForm
6. ✅ **Bundle awareness** - Inherited from ResourceSelector
7. ✅ **No duplicated UI** - All shared sections (resource, scope, severity, userHint, preview) inherited

---

## Files Created

### 1. CustomFHIRPathConfigSection.tsx
**Path:** `frontend/src/components/playground/Rules/rule-types/custom-fhirpath/CustomFHIRPathConfigSection.tsx`

**Responsibilities:**
- FHIRPath expression input (textarea, 4 rows, monospace font)
- Error code dropdown (GOVERNED - 8 validated codes)
- Conceptual model hint (blue panel explaining boolean validation)
- Governance notice (yellow panel explaining validation requirement)
- FHIRPath examples (gray panel with 5 example expressions)

**Governed Error Codes:**
1. FIELD_REQUIRED - Field is missing or empty
2. PATTERN_MISMATCH - Value does not match expected pattern
3. FIXED_VALUE_MISMATCH - Value does not match fixed value
4. VALUE_NOT_ALLOWED - Value is not in allowed set
5. INVALID_REFERENCE - Reference is invalid or broken
6. INVALID_CODE - Code is invalid or not in value set
7. ARRAY_LENGTH_VIOLATION - Array length constraint violated
8. CUSTOM_VALIDATION_FAILED - Custom validation logic failed

**Props:**
- `expression: string` - FHIRPath boolean expression
- `errorCode: string` - Selected error code (REQUIRED)
- `onExpressionChange: (expr: string) => void`
- `onErrorCodeChange: (code: string) => void`
- `errors?: { expression?: string; errorCode?: string }`
- `resourceType: string` - For contextual examples

**UI Features:**
- Expression textarea with placeholder showing resource type
- Error code dropdown with descriptions
- Real-time description display when code selected
- Validation error display for both fields
- Blue info panel explaining FHIRPath validation concept
- Yellow governance panel explaining errorCode requirement
- Gray examples panel with 5 common FHIRPath patterns

**Validation:**
- Expression: Required, non-empty
- ErrorCode: Required, must be from dropdown list

### 2. CustomFHIRPathRuleHelpers.ts
**Path:** `frontend/src/components/playground/Rules/rule-types/custom-fhirpath/CustomFHIRPathRuleHelpers.ts`

**Exports:**
- `buildCustomFHIRPathRule(params): Rule`
- `parseCustomFHIRPathRule(rule): { expression, errorCode }`

**Build Logic:**
```typescript
{
  id: 'rule-[timestamp]-[random]',
  type: 'CustomFHIRPath',
  resourceType: string,
  path: 'Patient[*]' // Instance-scoped path
  severity: 'error' | 'warning' | 'information',
  errorCode: string, // From governed dropdown
  params: {
    expression: string // Boolean FHIRPath
  },
  userHint?: string,
  message: '', // Generated by backend
  isMessageCustomized: false
}
```

**Parse Logic:**
- Extracts `expression` from `rule.params.expression`
- Extracts `errorCode` from `rule.errorCode`
- Returns for edit mode hydration

---

## Files Modified

### 1. RuleForm.tsx
**Path:** `frontend/src/components/playground/Rules/RuleForm.tsx`

**Changes Applied:**

#### Imports
```typescript
import { CustomFHIRPathConfigSection } from './rule-types/custom-fhirpath/CustomFHIRPathConfigSection';
import { buildCustomFHIRPathRule, parseCustomFHIRPathRule } from './rule-types/custom-fhirpath/CustomFHIRPathRuleHelpers';
```

#### RuleType Union
```typescript
type RuleType = 'Required' | 'Regex' | 'QuestionAnswer' | 'FixedValue' | 'AllowedValues' | 'ArrayLength' | 'CustomFHIRPath';
```

#### Error Code Mode Logic
```typescript
const getErrorCodeMode = (ruleType: RuleType): ErrorCodeMode => {
  if (ruleType === 'CustomFHIRPath') return 'governed'; // NEW
  // ... other modes
};
```

#### State Variables
```typescript
// CustomFHIRPath
const [customExpression, setCustomExpression] = useState<string>('');
const [customErrorCode, setCustomErrorCode] = useState<string>('');
```

#### Hydration Logic (Edit Mode)
```typescript
if (ruleType === 'CustomFHIRPath' && initialRule) {
  const parsed = parseCustomFHIRPathRule(initialRule as Rule);
  setCustomExpression(parsed.expression);
  setCustomErrorCode(parsed.errorCode);
  setGovernedErrorCode(parsed.errorCode);
}
```

#### Validation
```typescript
if (ruleType === 'CustomFHIRPath') {
  if (!customExpression) newErrors.expression = 'FHIRPath expression is required';
  if (!customErrorCode) newErrors.errorCode = 'Error code is required';
}
```

#### Rule Building
```typescript
} else if (ruleType === 'CustomFHIRPath') {
  rule = buildCustomFHIRPathRule({
    resourceType,
    instanceScope,
    expression: customExpression,
    errorCode: customErrorCode,
    severity,
    userHint: userHint || undefined,
  });
}
```

#### Config Section Rendering
```typescript
{ruleType === 'CustomFHIRPath' && (
  <CustomFHIRPathConfigSection
    expression={customExpression}
    errorCode={customErrorCode}
    onExpressionChange={(expr) => {
      setCustomExpression(expr);
      setErrors({ ...errors, expression: undefined });
    }}
    onErrorCodeChange={(code) => {
      setCustomErrorCode(code);
      setGovernedErrorCode(code);
      setErrors({ ...errors, errorCode: undefined });
    }}
    errors={{
      expression: errors.expression,
      errorCode: errors.errorCode,
    }}
    resourceType={resourceType}
  />
)}
```

#### ErrorCode Display Logic
```typescript
{/* ErrorCode section hidden for CustomFHIRPath - handled in config section */}
{ruleType !== 'CustomFHIRPath' && (
  <div>
    <label>Error Code</label>
    {/* Fixed/Runtime-determined display */}
  </div>
)}
```

**Rationale:** CustomFHIRPath handles errorCode in its config section (governed dropdown), so we hide the centralized ErrorCode display section for this rule type.

### 2. RuleTypeSelector.tsx
**Path:** `frontend/src/components/playground/Rules/add-rule/RuleTypeSelector.tsx`

**Changes Applied:**

#### Import
```typescript
import { Code } from 'lucide-react';
```

#### RuleTypeOption Union
```typescript
export type RuleTypeOption = 'required' | 'questionAnswer' | 'pattern' | 'fixedValue' | 'allowedValues' | 'arrayLength' | 'customFhirPath';
```

#### Rule Types Array
```typescript
{
  id: 'customFhirPath' as const,
  icon: Code,
  title: 'Custom FHIRPath',
  description: 'Write custom validation logic using FHIRPath expressions',
  enabled: true,
}
```

### 3. AddRuleModal.tsx
**Path:** `frontend/src/components/playground/Rules/add-rule/AddRuleModal.tsx`

**Changes Applied:**

#### Routing
```typescript
) : selectedRuleType === 'customFhirPath' ? (
  <RuleForm
    mode="create"
    ruleType="CustomFHIRPath"
    onCancel={handleCancel}
    onSave={handleSave}
    projectBundle={projectBundle}
    projectId={projectId}
  />
)
```

### 4. RuleEditorModal.tsx
**Path:** `frontend/src/components/playground/Rules/RuleEditorModal.tsx`

**Changes Applied:**

#### Routing Condition
```typescript
if (rule && ['Required', 'Regex', 'QuestionAnswer', 'FixedValue', 'AllowedValues', 'ArrayLength', 'CustomFHIRPath'].includes(rule.type)) {
  // Route to RuleForm
}
```

#### Type Cast
```typescript
ruleType={rule.type as 'Required' | 'Regex' | 'QuestionAnswer' | 'FixedValue' | 'AllowedValues' | 'ArrayLength' | 'CustomFHIRPath'}
```

---

## ErrorCode Governance Model

### Concept
CustomFHIRPath rules require **GOVERNED** error codes - user MUST select from a validated dropdown list. This ensures:
1. ✅ Error codes are consistent across rules
2. ✅ Backend can handle all error codes
3. ✅ No unknown/arbitrary error codes
4. ✅ Error codes are meaningful and documented

### Implementation
- **UI:** Dropdown (select element) with 8 predefined options
- **Validation:** Required field - cannot be empty
- **Display:** Real-time description shown when code selected
- **Governance Notice:** Yellow panel explaining validation requirement

### Contrast with Other Rule Types
| Rule Type | ErrorCode Mode | UI |
|-----------|----------------|-----|
| Required, Regex, FixedValue, AllowedValues, ArrayLength | Fixed | Blue badge (read-only) |
| QuestionAnswer | Runtime-determined | Green badge (automatic) |
| **CustomFHIRPath** | **Governed** | **Dropdown (required)** |

---

## UX Flow Examples

### Create Flow
1. User clicks "Add Rule" button
2. AddRuleModal opens with rule type selector
3. User clicks "Custom FHIRPath" option (Code icon)
4. **RuleForm opens in create mode**
5. User selects resource type (e.g., Patient) - ResourceSelector
6. User configures scope (All/Matching) - RuleScopeSelector
7. **User enters FHIRPath expression** - CustomFHIRPathConfigSection
8. **User selects error code from dropdown** - CustomFHIRPathConfigSection
9. User selects severity (error/warning/info) - SeveritySelector
10. User optionally adds userHint - UserHintInput
11. User reviews preview - RulePreviewPanel
12. User clicks "Create Rule"
13. RuleForm validates (expression + errorCode required)
14. Rule saved with governed errorCode

### Edit Flow
1. User clicks "Edit" on existing CustomFHIRPath rule
2. RuleEditorModal opens
3. **RuleForm opens in edit mode** with initialRule
4. **All fields hydrated from existing rule:**
   - Resource type: locked (disabled)
   - Scope: populated
   - **Expression: populated from params.expression**
   - **ErrorCode: populated from rule.errorCode**
   - Severity: populated
   - UserHint: populated
5. User modifies expression or errorCode
6. User clicks "Save Changes"
7. RuleForm validates
8. Rule updated with modified values (original ID preserved)

### Validation Examples

**Valid CustomFHIRPath Rule:**
```json
{
  "type": "CustomFHIRPath",
  "resourceType": "Patient",
  "path": "Patient[*]",
  "params": {
    "expression": "name.exists() and birthDate.exists()"
  },
  "errorCode": "CUSTOM_VALIDATION_FAILED",
  "severity": "error",
  "userHint": "Patient must have name and birth date"
}
```

**Invalid (Missing Expression):**
- Error: "FHIRPath expression is required"
- Field: Expression textarea highlighted red

**Invalid (Missing ErrorCode):**
- Error: "Error code is required"
- Field: ErrorCode dropdown highlighted red

**Invalid (Both Missing):**
- Both fields highlighted red
- Form cannot be saved

---

## FHIRPath Expression Guidelines

### Expected Format
- **Type:** Boolean expression
- **Return:** `true` = valid, `false` = error
- **Syntax:** Standard FHIRPath 2.0

### Examples Provided in UI
1. `name.exists()` - Name field must exist
2. `birthDate.exists() and birthDate <= today()` - Valid birth date
3. `telecom.where(system='phone').exists()` - Must have phone
4. `identifier.count() >= 1` - At least one identifier
5. `active = true` - Active must be true

### Resource Context
- Expression evaluated against resource type (e.g., Patient)
- Instance scope from path (Patient[*] or Patient[0])
- Backend evaluates expression and returns boolean

---

## Testing Checklist

### Create Flow
- [ ] CustomFHIRPath option appears in rule type selector
- [ ] Clicking CustomFHIRPath opens RuleForm
- [ ] Resource selector works (all types available)
- [ ] Scope selector works (All/Matching)
- [ ] Expression textarea accepts input
- [ ] ErrorCode dropdown shows 8 options
- [ ] Selecting errorCode shows description
- [ ] Severity selector works
- [ ] UserHint input works (60 char limit)
- [ ] Preview panel shows example error
- [ ] Validation: Expression required
- [ ] Validation: ErrorCode required
- [ ] Save creates rule with governed errorCode

### Edit Flow
- [ ] Editing CustomFHIRPath rule opens RuleForm
- [ ] Resource type locked (disabled)
- [ ] Expression hydrated from rule.params.expression
- [ ] ErrorCode hydrated from rule.errorCode
- [ ] Scope hydrated correctly
- [ ] Severity hydrated correctly
- [ ] UserHint hydrated correctly
- [ ] Can modify expression
- [ ] Can modify errorCode
- [ ] Save preserves original rule ID
- [ ] Save updates rule with changes

### Validation
- [ ] Empty expression shows error
- [ ] Empty errorCode shows error
- [ ] Both fields required to save
- [ ] Errors clear when fields filled
- [ ] Unknown errorCode rejected (if manually entered)

### UI/UX
- [ ] Blue info panel explains FHIRPath validation
- [ ] Yellow governance panel visible
- [ ] Gray examples panel shows 5 examples
- [ ] ErrorCode description updates on selection
- [ ] No duplicated resource/scope/severity UI
- [ ] No errorCode badge shown (handled in config section)
- [ ] Preview panel shows correct error preview

---

## Build Status

**Command:** `npm run build`  
**Result:** ✅ SUCCESS  
**Time:** 2.65s  
**Modules:** 2640 transformed  
**Bundle:** 796.29 kB (gzip: 213.14 kB)  
**TypeScript Errors:** 0  

---

## Unified Architecture Progress

| Rule Type | Status | ErrorCode Mode |
|-----------|--------|----------------|
| Required | ✅ Complete | Fixed |
| Regex | ✅ Complete | Fixed |
| QuestionAnswer | ✅ Complete | Runtime-determined |
| FixedValue | ✅ Complete | Fixed |
| AllowedValues | ✅ Complete | Fixed |
| ArrayLength | ✅ Complete | Fixed |
| **CustomFHIRPath** | ✅ **Complete** | **Governed** |
| CodeSystem | ⏳ Pending | TBD |

**Progress:** 7/8 rule types unified (87.5%)

---

## Next Steps

1. **End-to-End Testing** (HIGH PRIORITY)
   - Test CustomFHIRPath rule create flow
   - Test CustomFHIRPath rule edit flow
   - Verify errorCode governance works
   - Verify backend accepts governed error codes
   - Test all 8 error code options

2. **Migrate CodeSystem Rule Type** (MEDIUM PRIORITY)
   - Create CodeSystemConfigSection.tsx
   - Create CodeSystemRuleHelpers.ts
   - Update RuleForm with CodeSystem support
   - Update routing components
   - Determine errorCode mode for CodeSystem

3. **Delete Legacy Editor Code** (LOW PRIORITY)
   - Only CodeSystem uses legacy editor now
   - After CodeSystem migration, delete legacy editor entirely
   - Remove legacy form imports
   - Clean up unused code

4. **Documentation Updates** (LOW PRIORITY)
   - Update UNIFIED_RULE_ARCHITECTURE_COMPLETE.md
   - Add CustomFHIRPath to architecture examples
   - Document governed errorCode pattern

---

## Governance Rules Reflected in UI

### 1. ErrorCode Required
- ❌ Cannot save without selecting errorCode
- ✅ Validation error displayed
- ✅ Field highlighted red

### 2. ErrorCode Must Be From List
- ❌ Free-text input disabled
- ✅ Dropdown enforces selection
- ✅ Only 8 validated options

### 3. Unknown ErrorCode Invalid
- ❌ Cannot enter arbitrary codes
- ✅ UI prevents invalid input
- ✅ Governance notice explains requirement

### 4. ErrorCode Displayed in Config Section
- ❌ No separate errorCode badge
- ✅ Dropdown integrated in config section
- ✅ Description shown on selection

---

## Architecture Benefits

### ✅ Consistency
- CustomFHIRPath uses same UX skeleton as all other rules
- Resource → Scope → Config → Severity → UserHint → Preview
- No drift in UX between rule types

### ✅ Governance
- ErrorCode validated at UI level
- Impossible to create rule with invalid errorCode
- Consistent with backend ValidationErrorCodes enum

### ✅ Maintainability
- Single RuleForm entry point
- Config section handles ONLY rule-specific parameters
- Shared sections automatically apply updates

### ✅ Type Safety
- RuleType union includes CustomFHIRPath
- All state variables typed
- Config section props explicitly typed

### ✅ Scalability
- Adding CustomFHIRPath required:
  1. Create ConfigSection ✅
  2. Create Helpers ✅
  3. Update RuleForm ✅
  4. Update Routing ✅
- **NO need to:**
  - Duplicate resource selector
  - Duplicate scope selector
  - Duplicate severity selector
  - Create separate create/edit forms

---

## Key Implementation Decisions

### 1. ErrorCode in Config Section
**Decision:** Place errorCode dropdown in CustomFHIRPathConfigSection, not centralized section.

**Rationale:**
- CustomFHIRPath is the ONLY rule type with governed errorCode
- Expression and errorCode are tightly coupled (both define validation logic)
- Centralizing would add complexity (conditional dropdown)
- Config section keeps all rule-specific params together

**Result:** ErrorCode section hidden for CustomFHIRPath in RuleForm.

### 2. Governed List of 8 Codes
**Decision:** Hardcode 8 error codes in CustomFHIRPathConfigSection.

**Rationale:**
- Matches backend ValidationErrorCodes enum
- Ensures UI/backend consistency
- Simple dropdown implementation
- Easy to update if backend adds more codes

**Alternative Considered:** Fetch from backend API - rejected due to added complexity and synchronization overhead.

### 3. Expression Textarea (4 rows)
**Decision:** Multi-line textarea with 4 rows, monospace font.

**Rationale:**
- FHIRPath expressions can be long
- Multi-line improves readability
- Monospace font standard for code input
- 4 rows balances visibility and form height

### 4. No FHIRPath Validation
**Decision:** No client-side FHIRPath syntax validation.

**Rationale:**
- FHIRPath grammar complex (lexer/parser required)
- Backend validates expression during execution
- UI validation would add significant complexity
- False positives/negatives likely

**Result:** Required field validation only. Backend handles syntax validation.

---

## Summary

Successfully implemented CustomFHIRPath rule authoring using the unified RuleForm architecture:

- ✅ Created CustomFHIRPathConfigSection with governed errorCode dropdown
- ✅ Created CustomFHIRPathRuleHelpers with build/parse logic
- ✅ Updated RuleForm with CustomFHIRPath support
- ✅ Updated routing in AddRuleModal and RuleEditorModal
- ✅ Added CustomFHIRPath option to RuleTypeSelector
- ✅ All 7 architecture requirements met
- ✅ Build successful (0 errors)
- ✅ 7/8 rule types now unified (87.5% complete)

**ErrorCode Governance:** User MUST select from validated dropdown of 8 error codes. Unknown codes rejected at UI level.

**Next:** End-to-end testing + CodeSystem migration to complete unified architecture.

---

**Status:** ✅ IMPLEMENTATION COMPLETE  
**Date:** 29 December 2025  
**Files Created:** 2 (CustomFHIRPathConfigSection + Helpers)  
**Files Updated:** 4 (RuleForm, RuleTypeSelector, AddRuleModal, RuleEditorModal)  
**Breaking Changes:** None  
**Build Time:** 2.65s  
**Bundle Size:** 796.29 kB (gzip: 213.14 kB)  
**Rule Types Unified:** 7/8 (Required, Regex, QuestionAnswer, FixedValue, AllowedValues, ArrayLength, CustomFHIRPath)  
**Remaining:** CodeSystem
